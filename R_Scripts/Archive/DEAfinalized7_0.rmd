```{r} 
# Load necessary libraries 
library("tximport") 
library("readr")
library("DESeq2")
library("tximportData")
library("ggplot2")
library("tximeta")
library("magrittr")
library("dplyr")
library("tidyverse")
library("ggpubr")
library("pheatmap")
library("grid")
library("ggplotify")
library("gridExtra")
library("vsn")
library("RColorBrewer")
library("PoiClaClu")
library("glmpca")
library("ggbeeswarm")
library("apeglm")
library("genefilter")
if (!require("AnnotationHub")) BiocManager::install("AnnotationHub")
library(AnnotationHub)
```

```{R}
# List all of the quant.sf files
cwd <- getwd() 
par_dir <- dirname(cwd)
quant_fp <- paste(par_dir, 'quants', sep = '/') 
quant_files<- list.files(path = quant_fp, pattern = "quant.sf$", recursive = TRUE)
```

```{r}
# Extract sample names
quant_dirs <- list.files(quant_fp, 
                        pattern = "_quant$", 
                        full.names = TRUE)
sample_names <- gsub("_quant$", "", basename(quant_dirs)) 
# Correct for the FASTQ generation file included in the directory sample_names \<-
sample_names <- sample_names[1:48] # Ensure this range fits your data
```

```{r}
quant_fp
```

```{r}
# Create the txi import
txi <- tximport(files = paste(quant_fp, quant_files, sep = '/'), type = "salmon", txOut = TRUE)
```

```{r}
colnames(txi$abundance) <- sample_names
colnames(txi$counts) <- sample_names
colnames(txi$length) <- sample_names
```

```{r}
splitstrs <- strsplit(sample_names, "\\_|\\-")
string = splitstrs[[1]]
#length(splitstrs)
#splitstrs
```

```{r}
genotype <- c()
treatment <- c()
timepoint <- c()
replicate <- c()
for (i in 1:length(sample_names)){
  strippedConds = strsplit(sample_names, "\\_|\\-")
  genotype <- append(genotype, strippedConds[[i]][2])
  if (length(strippedConds[[i]]) == 4){
    treatment <- append(treatment, "Nind")
    if (strippedConds[[i]][3] == 1){
      timepoint <- append(timepoint, 5)
    } else if (strippedConds[[i]][3] == 3){
      timepoint <- append(timepoint, 18)
    }
    replicate <- append(replicate, strippedConds[[i]][4])
  }
  else if (length(strippedConds[[i]]) == 5){
    treatment = append(treatment, "ind")
    if (strippedConds[[i]][4] == 1){
      timepoint <- append(timepoint, 5)
    } else if (strippedConds[[i]][4] == 3){
      timepoint <- append(timepoint, 18)
    }
    replicate <- append(replicate, strippedConds[[i]][5])
  }
  
}
```

```{r}
samples <- sub("_L00",".",sample_names)
si_complete <-data.frame(samples=samples,
                         genotype=genotype,
                         treatment=treatment,
                         timepoint=timepoint,
                         replicate=replicate)
```
```{r}
si_complete
```
```{r}
coldata <- si_complete
coldata
coldata$names <- sub("_L00[0-9]+","",sample_names)
coldata$files <- paste(quant_fp, quant_files, sep="/")
coldata
```
```{r}
coldata <- subset(coldata, select = -replicate)
coldata
```

```{r}
se <- tximeta(coldata) #SummarizedExperiment Object
```
```{r}
if (!is.factor(se$treatment)){
  se$treatment <- factor(se$treatment)
}
if (!is.factor(se$timepoint)){
  se$timepoint <- factor(se$timepoint)
}
if (!is.factor(se$genotype)){
  se$genotype <- factor(se$genotype)
}
se$treatment %<>% relevel("Nind") # Nind is the base line to compare to. 
se$timepoint %<>% relevel("5")
se$genotype %<>% relevel("NC")
```

```{r}
design =~ genotype*timepoint*treatment #~ genotype + timepoint + treatment + genotype:timepoint + genotype:treatment + genotype:timepoint:treatment

dds <- DESeqDataSet(se, design = design)
#dds <- collapseReplicates(dds, dds$samples, dds$replicate)
meanSdPlot(assay(dds), ranks = FALSE)

log.cts.one <- log2(assay(dds) + 1)
meanSdPlot(log.cts.one, ranks = FALSE)
```
# Run Prefiltering because DESeqDataSet contains several rows that contain zeros or small amounts. Prefiltering will remove these and allow for increased speed when running functions.
```{r}
nrow(dds)
smallestGroupSize <- 4
keep <- rowSums(counts(dds) >= 10) >= smallestGroupSize
dds <- dds[keep,]
nrow(dds)
```
# Lets look at the simulated data of what the counts should look like if they follow a poisson distribution.
```{r}
lambda <- 10^seq(from = -1, to = 2, length = 1000)
cts <- matrix(rpois(1000*100, lambda), ncol = 100)
meanSdPlot(cts, ranks = FALSE)

log.cts.one <- log2(cts + 1)
meanSdPlot(log.cts.one, ranks = FALSE)
```
# Now we will compare the variance stabilizing transformation (VST), regularized-logarithm transformation (rlog), and log2 transformation.
```{r}
vsd <- varianceStabilizingTransformation(dds, blind = FALSE)
#head(assay(vsd), 3)
```
```{r}
rld <- rlog(dds, blind = FALSE)
#head(assay(rld), 3)
```
```{r}
dds <- estimateSizeFactors(dds)

df <- bind_rows(
  as_data_frame(log2(counts(dds, normalized=TRUE)[, c(7,11)]+1)) %>%
         mutate(transformation = "log2(x + 1)"),
  as_data_frame(assay(vsd)[, c(7,11)]) %>% mutate(transformation = "vst"),
  as_data_frame(assay(rld)[, c(7,11)]) %>% mutate(transformation = "rlog"))
  
colnames(df)[1:2] <- c("x", "y")  

lvls <- c("log2(x + 1)", "vst", "rlog")
df$transformation <- factor(df$transformation, levels=lvls)

ggplot(df, aes(x = x, y = y)) + geom_hex(bins = 80) +
  coord_fixed() + facet_grid( . ~ transformation) 
```
# Now we can look at the euclidean distance between the sample to check for similarity between them.
```{r}
sampleDists <- dist(t(assay(dds)))
```
# And Create a heatmap to visualize.
```{r}
sampleDistMatrix <- as.matrix( sampleDists )
rownames(sampleDistMatrix) <- paste( dds$treatment, dds$genotype, dds$timepoint, sep = "-" )
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
pheatmap(sampleDistMatrix,
         clustering_distance_rows = sampleDists,
         clustering_distance_cols = sampleDists,
         col = colors)
```
# Do the same using a poisson distance.
```{r}
poisd <- PoissonDistance(t(counts(dds)))
samplePoisDistMatrix <- as.matrix( poisd$dd )
rownames(samplePoisDistMatrix) <- paste( dds$treatment, dds$genotype, sep=" - " )
colnames(samplePoisDistMatrix) <- NULL
pheatmap(samplePoisDistMatrix,
         clustering_distance_rows = poisd$dd,
         clustering_distance_cols = poisd$dd,
         col = colors)
```
# Finally with a PCA.
```{r}
plotPCA(vsd, intgroup = c("treatment", "genotype", "timepoint"))
```
```{r}
pcaData <- plotPCA(vsd, intgroup = c( "treatment", "genotype", "timepoint"), returnData = TRUE)
pcaData
percentVar <- round(100 * attr(pcaData, "percentVar"))
ggplot(pcaData, aes(x = PC1, y = PC2, color = treatment, shape = genotype)) +
  geom_point(size =3, mapping = aes(alpha = timepoint)) +
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar[2], "% variance")) +
  coord_fixed() +
  ggtitle("PCA with VST data")
```
# Finally, finally with a generalized PCA (GLM-PCA)
```{r}
gpca <- glmpca(counts(dds), L=2)
gpca.dat <- gpca$factors
gpca.dat$treatment <- dds$treatment
gpca.dat$genotype <- dds$genotype
gpca.dat$timepoint <- dds$timepoint

ggplot(gpca.dat, aes(x = dim1, y = dim2, color = treatment, shape = genotype)) + geom_point(size =3, mapping = aes(aplha = timepoint)) + coord_fixed() + ggtitle("glmpca - Generalized PCA")
```
# multidimensional scaling plot.
```{r}
mds <- as.data.frame(colData(vsd))  %>%
         cbind(cmdscale(sampleDistMatrix))
ggplot(mds, aes(x = `1`, y = `2`, color = treatment, shape = genotype, alpha = timepoint)) +
  geom_point(size = 3) + coord_fixed() + ggtitle("MDS with VST data")
```
```{r}
topGene <- rownames(res)[which.max(res$log2FoldChange)]
plotCounts(dds, gene = topGene, intgroup=c("treatment", "genotype", "timepoint"))
```

```{r}
geneCounts <- plotCounts(dds, gene = topGene, intgroup = c("treatment","genotype", "timepoint"),
                         returnData = TRUE)
ggplot(geneCounts, aes(x = timepoint, y = count, color = genotype, shape = treatment)) +
  scale_y_log10() +  geom_beeswarm(cex = 3)
```

```{r}
ggplot(geneCounts, aes(x = timepoint, y = count, color = genotype, group = interaction(genotype, treatment), shape = treatment)) +
  scale_y_log10() + geom_point(size = 3) + geom_line()
```


```{r, fig.height=12, fig.width=7}}
font = "Helvetica"
design <- ~ genotype + timepoint + genotype:timepoint + treatment:genotype:timepoint
#design =~ genotype + timepoint + treatment

dds <- DESeqDataSet(se, design = design)
dds <- DESeq(dds)
resultsNames(dds)

# Assuming 'rld' is your rlog-transformed data (or use vst()), filter 
# for the top 50.
gene_variance <- apply(assay(rld), 1, var)  # Variance per gene

# Sort genes by variance (descending) and take top 50
top_50_genes <- names(sort(gene_variance, decreasing = TRUE)[1:50])

# Get LFCs for s4 at 5hr
res_s4_5hr <- results(
  dds, 
  contrast = list(
    c("genotypes4.timepoint5.treatmentind")
  )
)[top_50_genes,]

# Get LFCs for NC at 5hr
res_NC_5hr <- results(
  dds, 
  contrast = list(
    c("genotypeNC.timepoint5.treatmentind")
  )
)[top_50_genes,]

# Get LFCs for WT at 5hr
res_WT_5hr <- results(
  dds, 
  contrast = list(
    c("genotypeWT.timepoint5.treatmentind")
  )
)[top_50_genes,]

# Filtering
rRNAgenes <- c("rrl*", "rrs*")
# significant genes for Wild Type, Negative control, and s4 at 5 hr.
sig_genes <- unique(c(
  rownames(subset(res_NC_5hr, padj < 0.05 & abs(log2FoldChange) > 1 & !grepl(rRNAgenes, rownames(res_NC_5hr)))),
  rownames(subset(res_s4_5hr, padj < 0.05 & abs(log2FoldChange) > 1 & !grepl(rRNAgenes, rownames(res_s4_5hr)))),
  rownames(subset(res_WT_5hr, padj < 0.05 & abs(log2FoldChange) > 1 & !grepl(rRNAgenes, rownames(res_WT_5hr))))
))

# Now create data frames from each of the results and
# and assign genes and genotypes data.
WT_5hr_df <- data.frame(
  Gene = rownames(res_WT_5hr),
  log2FoldChange = res_WT_5hr$log2FoldChange,
  padj = res_WT_5hr$padj,
  GenoType = "WT"
)
NC_5hr_df <- data.frame(
  Gene = rownames(res_NC_5hr),
  log2FoldChange = res_NC_5hr$log2FoldChange,
  padj = res_NC_5hr$padj,
  GenoType = "NC"
)
s4_5hr_df <- data.frame(
  Gene = rownames(res_s4_5hr),
  log2FoldChange = res_s4_5hr$log2FoldChange,
  padj = res_s4_5hr$padj,
  GenoType = "s4"
)


# Combine and prepare the data
heatmap_data <- rbind(WT_5hr_df, NC_5hr_df, s4_5hr_df) %>%
  filter(Gene %in% sig_genes) %>%
  mutate(
    # Add significance stars
    sig_star = ifelse(padj < 0.001, "***",
                     ifelse(padj < 0.01, "**",
                            ifelse(padj < 0.05, "*", ""))),
    # Order genes by average absolute LFC (REVERSED - most responsive at TOP)
    Gene = factor(Gene, levels = heatmap_data %>%
                   group_by(Gene) %>%
                   summarize(mean_abs_lfc = mean(abs(log2FoldChange))) %>%
                   arrange(mean_abs_lfc) %>%  # Changed from desc() to ascending
                   pull(Gene))  # Added rev() to reverse the order
  )

# Set symmetric color limits based on max absolute LFC
lfc_limit <- max(abs(heatmap_data$log2FoldChange), na.rm = TRUE) * 1.1
# Calculate optimal dimensions based on your data
n_genes <- length(unique(heatmap_data$Gene))
n_conditions <- length(unique(heatmap_data$GenoType))

# Set your target dimensions (in inches)
fig_width <- 10 # Your specified width
fig_height <- 20 # Your specified height

# Calculate optimal tile aspect ratio
tile_aspect_ratio <- (fig_height/fig_width)*(n_conditions/n_genes)

# Create the enhanced heatmap
l2f_heatmap <- ggplot(heatmap_data, 
                          aes(x = GenoType, y = Gene, fill = log2FoldChange)) + 
  geom_tile(color = "white", width = 0.95, height = 0.95) +#, width = 0.95, height = 0.95) +  # Add white grid lines
  coord_fixed(ratio = tile_aspect_ratio) +
  geom_text(aes(label = sig_star), 
            color = "black", size = 3, vjust = 0.8) +  # Add significance stars
  scale_fill_distiller(
    palette = "RdGy",
    limits = c(-lfc_limit, lfc_limit),  # Symmetric color scale
    na.value = "grey90"
  ) +
  theme_minimal(base_family = "Helvetica") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.text.y = element_text(size = 8),
    plot.margin = margin(5, 5, 5, 5, "pt") # Tight margins
  ) +
  labs(
    x = "Genotype",
    y = "Gene",
    fill = "Log2FC\n(Ind vs Nind)",
    caption = "Significance: *p<0.05, **p<0.01, ***p<0.001"
  ) 
print(l2f_heatmap)
# Save the plot
ggsave("../Figures/enhanced_heatmap.png", 
       l2f_heatmap, 
       dpi = 600, 
       height = fig_height, 
       width = fig_width)
```
# Now let's retrieve the annotation information for MG1655z1 so we can cluster based on function.
```{r}
library(RCurl)
library(org.EcK12.eg.db)
library(AnnotationDbi)


# Check current format
str(heatmap_data$Gene)  # Should show 'chr' not 'factor' or 'numeric'

# Force convert to character if needed
heatmap_data$Gene <- as.character(heatmap_data$Gene)

# Remove NA/blank entries
heatmap_data <- heatmap_data[!is.na(heatmap_data$Gene) & heatmap_data$Gene != "", ]


# Method 1: Using locus tags (b-numbers)
tryCatch({
  annotations <- AnnotationDbi::select(org.EcK12.eg.db,
                      keys = unique(heatmap_data$Gene),  # Unique genes only
                      columns = c("GENENAME", "PATH"), #, "UNIPROT"),
                      keytype = "ALIAS")
}, error = function(e) {
  message("Error with ALIAS keytype. Trying alternative methods...")
  
  # Method 2: Try ENTREZID if genes are numeric
  if(all(grepl("^\\d+$", heatmap_data$Gene))) {
    annotations <- select(org.EcK12.eg.db,
                        keys = unique(heatmap_data$Gene),
                        columns = c("GENENAME", "PATH"),
                        keytype = "ENTREZID")
  } 
  # Method 3: Try SYMBOL (common gene names)
  else {
    annotations <- select(org.EcK12.eg.db,
                        keys = unique(heatmap_data$Gene),
                        columns = c("ORF", "PATH"),
                        keytype = "SYMBOL")
  }
})

# Check if any annotations were found
if(nrow(annotations) == 0) {
  stop("No annotations found. Verify your gene IDs match the database.")
}
heatmap_annotated <- heatmap_data %>%
  left_join(annotations, by = c("Gene" = "ALIAS")) %>%  # Adjust "ALIAS" to your keytype
  mutate(
    DisplayName = case_when(
      !is.na(GENENAME) ~ paste0(Gene, "|", GENENAME),
      !is.na(PATH) ~ paste0(Gene, "|", PATH),
      TRUE ~ Gene
    )
  )

library(ggplot2)

# Calculate dynamic sizing
n_genes <- length(unique(heatmap_annotated$Gene))
gene_height <- max(2, 10 - n_genes/15)  # Adjust text size based on gene count

ggplot(heatmap_annotated, aes(x = GenoType, y = DisplayName, fill = log2FoldChange)) +
  geom_tile(width = 0.95, height = 0.95) +
   geom_text(aes(label = sig_star), 
            color = "black", size = 3, vjust = 0.8) +  # Add significance stars +
  scale_fill_distiller(
    palette = "RdGy",
    limits = c(-lfc_limit, lfc_limit),  # Symmetric color scale
    na.value = "grey90"
  ) +
  theme_minimal(base_family = "Helvetica") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.text.y = element_text(size = 8),
    plot.margin = margin(5, 5, 5, 5, "pt") # Tight margins
  ) +
  labs(
    x = "Genotype",
    y = "Gene",
    fill = "Log_2 FC\n(Ind vs Nind)",
    caption = "Significance: *p<0.05, **p<0.01, ***p<0.001"
  ) +
  labs(y = "Gene (Annotation)")
```
```{r, fig.height=12, fig.width=12}
# 1. Sort by Maximum LFC
max_lfc_order <- heatmap_data %>%
  group_by(Gene) %>%
  summarize(max_lfc = max(abs(log2FoldChange))) %>%
  arrange(max_lfc) %>%
  pull(Gene)

# 2. Hierarchical Clustering
lfc_matrix <- heatmap_data %>%
  select(Gene, GenoType, log2FoldChange) %>%
  pivot_wider(names_from = GenoType, values_from = log2FoldChange) %>%
  column_to_rownames("Gene") %>%
  as.matrix()
cluster_order <- rownames(lfc_matrix)[hclust(dist(lfc_matrix))$order]

# 4. Up/Down Regulation
direction_order <- heatmap_data %>%
  group_by(Gene) %>%
  summarize(mean_direction = mean(log2FoldChange)) %>%
  mutate(direction = ifelse(mean_direction > 0, "Up", "Down")) %>%
  arrange(direction, desc(abs(mean_direction))) %>%
  rev() %>%
  pull(Gene)

# 5. Variation among GenoTypes
variation_order <- heatmap_data %>%
  group_by(Gene) %>%
  summarize(
    max_lfc = max(log2FoldChange),
    min_lfc = min(log2FoldChange),
    range_lfc = max_lfc - min_lfc  # This measures the variation
  ) %>%
  arrange(desc(range_lfc)) %>%  # Sort by range (descending)
  pull(Gene)

# Create comparison plot
plots <- list()

# Set your target dimensions (in inches)
fig_width <- 10 # Your specified width
fig_height <- 20 # Your specified height

# Calculate optimal tile aspect ratio
tile_aspect_ratio <- (fig_height/fig_width)*(n_conditions/n_genes)

desired_genotype_order <- c("WT", "NC", "s4")

# Method 1: Max LFC
plots[[1]] <- heatmap_data %>%
  mutate(Gene = factor(Gene, levels = max_lfc_order),
         GenoType = factor(GenoType, levels = desired_genotype_order)) %>%
  ggplot(aes(x = GenoType, y = Gene, fill = log2FoldChange)) +
  geom_tile(color = "white", width = 0.95, height = 0.95) +
  geom_text(aes(label = sig_star), 
            color = "black", size = 3, vjust = 0.8) +  # Add significance stars
  scale_fill_distiller(
    palette = "RdGy",
    limits = c(-lfc_limit, lfc_limit),  # Symmetric color scale
    na.value = "grey90"
  ) +
  theme_minimal(base_family = "Helvetica") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.text.y = element_text(size = 8),
    plot.margin = margin(5, 5, 5, 5, "pt") # Tight margins
  ) +
  labs(
    title = "Max LFC",
    x = "Genotype",
    y = "Gene",
    fill = "Log2FC\n(Ind vs Nind)",
    caption = "Significance: *p<0.05, **p<0.01, ***p<0.001"
  )

# Method 2: Clustering
plots[[2]] <- heatmap_data %>%
  mutate(Gene = factor(Gene, levels = cluster_order),
         GenoType = factor(GenoType, levels = desired_genotype_order)) %>%
  ggplot(aes(x = GenoType, y = Gene, fill = log2FoldChange)) +
  geom_tile(color = "white", width = 0.95, height = 0.95) +
  coord_fixed(ratio = tile_aspect_ratio) +
  geom_text(aes(label = sig_star), 
            color = "black", size = 3, vjust = 0.8) +  # Add significance stars
  scale_fill_distiller(
    palette = "RdGy",
    limits = c(-lfc_limit, lfc_limit),  # Symmetric color scale
    na.value = "grey90"
  ) +
  theme_minimal(base_family = "Helvetica") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.text.y = element_text(size = 8),
    plot.margin = margin(5, 5, 5, 5, "pt") # Tight margins
  ) +
  labs(
    title = "Hierarchical Clustering",
    x = "Genotype",
    y = "Gene",
    fill = "Log2FC\n(Ind vs Nind)",
    caption = "Significance: *p<0.05, **p<0.01, ***p<0.001"
  )

# Create the enhanced heatmap
plots[[3]] <- heatmap_data %>%
  mutate(Gene = factor(Gene, levels = variation_order),
         GenoType = factor(GenoType, levels = desired_genotype_order)) %>%
  ggplot(aes(x = GenoType, y = Gene, fill = log2FoldChange)) + 
  geom_tile(color = "white", width = 0.95, height = 0.95) +#, width = 0.95, height = 0.95) +  # Add white grid lines
  coord_fixed(ratio = tile_aspect_ratio) +
  geom_text(aes(label = sig_star), 
            color = "black", size = 3, vjust = 0.8) +  # Add significance stars
  scale_fill_distiller(
    palette = "RdGy",
    limits = c(-lfc_limit, lfc_limit),  # Symmetric color scale
    na.value = "grey90"
  ) +
  theme_minimal(base_family = "Helvetica") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.text.y = element_text(size = 8),
    plot.margin = margin(5, 5, 5, 5, "pt") # Tight margins
  ) +
  labs(
    title = " Max Mean LFC",
    x = "Genotype",
    y = "Gene",
    fill = "Log2FC\n(Ind vs Nind)",
    caption = "Significance: *p<0.05, **p<0.01, ***p<0.001"
  ) 


# Method 4: Up/Down Regulation
plots[[4]] <- heatmap_data %>%
  mutate(Gene = factor(Gene, levels = direction_order),
         GenoType = factor(GenoType, levels = desired_genotype_order)) %>%
  ggplot(aes(x = GenoType, y = Gene, fill = log2FoldChange)) +
  geom_tile(color = "white", width = 0.95, height = 0.95) +
  coord_fixed(ratio = tile_aspect_ratio) +
  geom_text(aes(label = sig_star), 
            color = "black", size = 3, vjust = 0.8) +  # Add significance stars
  scale_fill_distiller(
    palette = "RdGy",
    limits = c(-lfc_limit, lfc_limit),  # Symmetric color scale
    na.value = "grey90"
  ) +
  theme_minimal(base_family = "Helvetica") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.text.y = element_text(size = 8),
    plot.margin = margin(5, 5, 5, 5, "pt") # Tight margins
  ) +
  labs(
    title = "Up/Down Regulation",
    x = "Genotype",
    y = "Gene",
    fill = "Log2FC\n(Ind vs Nind)",
    caption = "Significance: *p<0.05, **p<0.01, ***p<0.001"
  )

# Combine plots
library(patchwork)
combined_plot <- wrap_plots(plots, ncol = 2) +
  plot_annotation(title = "Comparison of Gene Sorting Methods") &
  scale_fill_gradient2(low = "blue", mid = "white", high = "red") &
  theme_minimal()
print(combined_plot)
# Save
ggsave("sorting_methods_comparison.png", combined_plot, 
       width = 14, height = 16, dpi = 300)
```

```{r}
top_hits <- ggplot(var_l2f_df, aes(x=colname, y=rowname, fill=value)) + 
  geom_tile() +
  scale_fill_distiller(palette="RdGy") +
  theme(axis.text.x = element_text(family=font, size=fsize)) +
  theme(axis.text.y = element_text(family=font, size=fsize)) +
  coord_cartesian(clip = "off") +
  facet_wrap( ~timepoint, scales="free_x" ) +
  scale_x_discrete(labels = columns) +
  xlab("Treatment") +
  ylab("Gene")+
  labs(fill="Log2fold\nChange")
print(top_hits)
ggsave("../Figures/varTophitsNC_vs_s47v7.png", top_hits, dpi=600)
```





```{r}

```

```{r}
dds <- DESeq(dds)
rld <- rlog(dds, blind = FALSE)
resultsNames(dds)
```
```{r}
res <- lfcShrink(dds, coef="treatment_ind_vs_Nind" , type="apeglm")
plotMA(res, ylim = c(-10, 10))
res.noshr <- results(dds, name="timepoint_18_vs_5" )
plotMA(res.noshr, ylim = c(-10, 10))
plotMA(res, ylim = c(-10,10))
topGene <- rownames(res)[which.min(res$padj)]
with(res[topGene, ], {
  points(baseMean, log2FoldChange, col="dodgerblue", cex=2, lwd=2)
  text(baseMean, log2FoldChange, topGene, pos=2, col="dodgerblue")
})
hist(res.noshr$pvalue[res.noshr$baseMean > 1], breaks = 0:20/20,
     col = "grey50", border = "white")
```
```{r}
ddsNR <- DESeqDataSet(se, design = design)
```

```{r, fig.height=12, fig.width=7}
font = "Helvetica"
counts_df <- data.frame(counts(ddsNR))
counts_df <- counts_df[rowSums(counts_df >= 10) >= 4, ]

counts_df <- log(counts_df,10)

var_counts <- apply(counts_df, MARGIN=1, FUN= var)
var_counts_df = data.frame(Var=var_counts)
rownames(var_counts_df) <- rownames(counts_df)

varCounts_l2f_df <- counts_df[order(var_counts_df$Var, decreasing=FALSE), , drop=FALSE]
varCounts_l2f_df

col_names = colnames(varCounts_l2f_df)
col_names
cleaned_col_names <- sub(".*ATEY090523\\.", "", col_names)
cleaned_col_names

# Extract the first number and save to a new array
timepoint <- sub(".*_(\\d+).*", "\\1", cleaned_col_names)
timepoints <- paste("Timepoint: ", timepoint, "hr.")

# Combine the second number (if present) with the word portion
processed_sample <- sub("^(.*?)_(\\d+)(\\..*)?$", "\\1\\3", cleaned_col_names)
processed_sample

varCounts_l2f_df <- varCounts_l2f_df %>% rownames_to_column() %>% gather(colname, value, -rowname)
varCounts_l2f_df <- varCounts_l2f_df %>%
  mutate(
    timepoint = paste("Timepoint: ", as.numeric(str_extract(colname, "(?<=_)[0-9]+")), "hr.")  # Extract the number after the underscore and convert to numeric
  )
columns <- c("Non-Targeting\ngRNA", "Targeting\ngRNA", "Non-Targeting\ngRNA", "Targeting\ngRNA")

varCounts_l2f_df$colname  <- factor(varCounts_l2f_df$colname, levels=unique(varCounts_l2f_df$colname))
varCounts_l2f_df$timepoint <- factor(varCounts_l2f_df$timepoint, levels=unique(varCounts_l2f_df$timepoint))
varCounts_l2f_df
varCounts_l2f_df$rowname<-factor(varCounts_l2f_df$rowname, levels=unique(varCounts_l2f_df$rowname))

fsize = 5

Counts_top_hits <- ggplot(varCounts_l2f_df, aes(x=colname, y=rowname, fill=value)) + 
  geom_tile() +
  scale_fill_distiller(palette="RdGy") +
  theme(axis.text.x = element_text(angle=270, family=font, size=fsize)) +
  theme(axis.text.y = element_text(family=font, size=fsize)) +
  coord_cartesian(clip = "off") +
  facet_wrap( ~timepoint, scales="free_x" ) +
  scale_x_discrete(labels = unique(processed_sample)) +
  xlab("Treatment") +
  ylab("Gene")+
  labs(fill="Log10Counts")
print(Counts_top_hits)
ggsave("../Figures/CountsTopHits.png", Counts_top_hits, dpi=600)
```



```{r, fig.height=7, fig.width=7}
n_topgenes = 50
topVarGenes <- head(order(rowVars(assay(rld)), decreasing = TRUE), n_topgenes)
mat  <- assay(rld)[ topVarGenes, ]
mat
col_order = c("ATEY090523-WT_1",
              "ATEY090523-WT_ind_1",
              "ATEY090523-NC_1",
              "ATEY090523-NC_ind_1",
              "ATEY090523-s4_1",
              "ATEY090523-s4_ind_1",
              "ATEY090523-WT_3",
              "ATEY090523-WT_ind_3",
              "ATEY090523-NC_3",
              "ATEY090523-NC_ind_3",
              "ATEY090523-s4_3",
              "ATEY090523-s4_ind_3"
)
col_names = c("WT 5 hr.",
              "WT Induced 5 hr.",
              "NC 5 hr.", 
              "NC Induced 5 hr.",
              "s4 5 hr.",
              "s4 Induced 5 hr.",
              "WT 18 hr.",
              "WT Induced 18 hr.",
              "NC 18 hr.", 
              "NC Induced 18 hr.",
              "s4 18 hr.",
              "s4 Induced 18 hr."
)
mat <- mat[,col_order]
mat  <- mat - rowMeans(mat)
anno <- as.data.frame(colData(vsd)[, c("genotype","treatment", "timepoint")])
pheatmap(mat, 
         annotation_col = anno,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(100),
         angle_col = 315,
         width = fig.width,
         height = fig.height,
         cluster_cols=FALSE,
         cluster_rows =FALSE,
         labels_col = col_names
)
```
```{r, fig.height=7, fig.width=7}
res <- results(dds, contrast = c("treatment", "ind", "Nind"))
res

resOrdered <- res[order(res$log2FoldChange), ]
top_genes <- head(resOrdered, n_topgenes)

inds <- rownames(top_genes)
mat <- assay(rld)[inds,]

col_order = c("ATEY090523-WT_1",
              "ATEY090523-WT_ind_1",
              "ATEY090523-NC_1",
              "ATEY090523-NC_ind_1",
              "ATEY090523-s4_1",
              "ATEY090523-s4_ind_1",
              "ATEY090523-WT_3",
              "ATEY090523-WT_ind_3",
              "ATEY090523-NC_3",
              "ATEY090523-NC_ind_3",
              "ATEY090523-s4_3",
              "ATEY090523-s4_ind_3"
)
col_names = c("WT 5 hr.",
              "WT Induced 5 hr.",
              "NC 5 hr.", 
              "NC Induced 5 hr.",
              "s4 5 hr.",
              "s4 Induced 5 hr.",
              "WT 18 hr.",
              "WT Induced 18 hr.",
              "NC 18 hr.", 
              "NC Induced 18 hr.",
              "s4 18 hr.",
              "s4 Induced 18 hr."
)
mat <- mat[,col_order]
mat  <- mat - rowMeans(mat)
anno <- as.data.frame(colData(vsd)[, c("genotype","treatment", "timepoint")])
log2FC_heatmap <- pheatmap(mat, 
         annotation_col = anno,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(100),
         angle_col = 315,
         width = fig.width,
         height = fig.height,
         cluster_cols=FALSE,
         cluster_rows=FALSE,
         labels_col = col_names
)
resOrdered

```
```{r, fig.height=20, fig.width=7}
contrast = list("treatment_ind_vs_Nind")
resNC <- results(dds, contrast = contrast)#("genotypeNC.timepoint18.treatmentind"))
ress4 <- results(dds, contrast = contrast)#("genotypeNC.timepoint18.treatmentind"))
sig_resNC <- subset(resNC, padj < 0.01)
sig_ress4 <- subset(ress4, padj < 0.01)

l2f_NC = as.data.frame(sig_resNC$log2FoldChange)
rownames(l2f_NC) <- rownames(sig_resNC)
colnames(l2f_NC) <- ("WT 5hr untreated vs. NC 18hr treated")

l2f_s4 <- as.data.frame(sig_ress4$log2FoldChange)
rownames(l2f_s4) <- rownames(sig_ress4)
colnames(l2f_s4) <- ("WT 5hr untreated vs. s8 18hr treated")

l2f_matrix <- cbind(l2f_NC, l2f_s4)

# Generate heatmap
pheatmap(l2f_matrix, 
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(50),
         angle_col = 315,
         width = fig.width,
         height = fig.height,
         cluster_cols=FALSE,
         cluster_rows=FALSE,
)

```
```{r, fig.height=25, fig.width=15}
coldata5 = coldata[coldata$timepoint == 5,]
coldata18 = coldata[coldata$timepoint == 18,]

coldata5 <-subset(coldata5, select = -timepoint)
coldata18 <- subset(coldata18, select = -timepoint)
se5 <- tximeta(coldata5)
se18 <- tximeta(coldata18)
coldata5

se5$treatment <- relevel(factor(se5$treatment), ref = "Nind") # Nind is the base line to compare to.
se5$genotype <- relevel(factor(se5$genotype), ref = "NC") 
se18$treatment <- relevel(factor(se18$treatment), ref = "Nind") 
se18$genotype <- relevel(factor(se18$genotype), ref = "NC") 

design = ~ genotype + treatment + genotype:treatment
dds5 <- DESeqDataSet(se5, design = design)
dds18 <- DESeqDataSet(se18, design = design)

dds5 <- DESeq(dds5)
dds18 <- DESeq(dds18)

rld5 <- rlog(dds5, blind = FALSE)
rld18 <- rlog(dds18, blind = FALSE)

resultsNames(dds5)
resultsNames(dds18)

contrast = list("treatment_ind_vs_Nind")
res5s4 <- results(dds5, contrast = contrast)
res18s4 <- results(dds18, contrast = contrast)


n_topgenes = 4577
n_topVarGenes = 75
topVarGenes <- head(order(rowVars(assay(dds)), decreasing = TRUE), n_topgenes)

topgenes5s4 <- rownames(head(res5s4[order(res5s4$log2FoldChange, decreasing = TRUE),], n_topgenes))
topgenes18s4 <- rownames(head(res18s4[order(res18s4$log2FoldChange, decreasing = TRUE),], n_topgenes))



sig_res5s4 <- rownames(subset(res5s4, padj < 0.01))
sig_res18s4 <- rownames(subset(res18s4, padj < 0.01))

l2f_5_s4 <- as.data.frame(res5s4$log2FoldChange)
rownames(l2f_5_s4) <- rownames(res5s4)
l2f_5_s4 <- l2f_5_s4[topgenes5s4, , drop=FALSE]
l2f_5_s4$rownames <- topgenes5s4
#colnames("WT 5hr untreated vs. st 18hr treated")

l2f_18_s4 <- as.data.frame(res18s4$log2FoldChange)
rownames(l2f_18_s4) <- rownames(res18s4)
l2f_18_s4 <- l2f_18_s4[topgenes18s4, , drop=FALSE]
l2f_18_s4$rownames <- topgenes18s4
#colnames("WT 5hr untreated vs. st 18hr treated")

l <- list(l2f_5_s4, l2f_18_s4)
l2f_df <- Reduce(function(x, y) merge(x, y, by="rownames", all=T), l)
rownames(l2f_df) <- l2f_df$rownames
l2f_df <- l2f_df[,-1]
l2f_raw_df <- data.frame(l2f_df)
l2f_raw_df[is.na(l2f_raw_df)]<-0
l2f_df <- na.omit(l2f_df)
colnames(l2f_raw_df) <- c("Targeting5hr", "Targeting18hr")
colnames(l2f_df) <- c("Targeting5hr", "Targeting18hr")
l2f_df_tv <-l2f_raw_df[topVarGenes, ] # Total Variance accross samples.
l2f_df_5_s4 <- l2f_raw_df[order(abs(l2f_df$Targeting5hr), decreasing = TRUE), , drop=FALSE]

clusterRows <- TRUE
clusterCols <- FALSE

# Generate heatmap
phm <- pheatmap(l2f_raw_df, 
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(n_topgenes),
         angle_col = 315,
         width = fig.width,
         height = fig.height,
         cluster_cols=clusterCols,
         cluster_rows=clusterRows,
)

phm_tv <- pheatmap(l2f_df_tv, 
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(n_topgenes),
         angle_col = 315,
         width = fig.width,
         height = fig.height,
         cluster_cols=clusterCols,
         cluster_rows=clusterRows,
)
phm_5_s4 <- pheatmap(l2f_df_5_s4, 
         color = colorRampPalette(rev(brewer.pal(n = 9, name = "RdGy")))(n_topgenes),
         angle_col = 315,
         width = fig.width,
         height = fig.height,
         cluster_cols=clusterCols,
         cluster_rows=clusterRows,
)

grid.arrange(as.grob(phm), as.grob(phm_tv), as.grob(phm_5_s4), ncol=3)

```

```{r}
genes <- c(
  # SOS responsive, LexA-dependent genes
  "polB", "recA", "recN", "sbmC", "ssb", "sulA", "uvrA", "uvrB",
  
  # LexA-independent genes
  "dnaA", "nrdA", "nrdB", "cydA", "tdcB", "tdcC", "cstA", "sspA", "sspB",
  "deoA", "deoB", "deoC", "dnaG", "gmk", "gyrA", "gyrB", "intZ", "mcrB", "oraA", "pyrG",
  
  # Anaerobic induction
  "cydA", "tdcB", "tdcC",
  
  # Starvation induction
  "cstA", "sspA", "sspB",
  
  # Other regulation
  "deoA", "deoB", "deoC", "dnaG", "gmk", "gyrA", "gyrB", "intZ", "mcrB", "oraA", "pyrG",
  
  # Transcription-related genes
  "fliA", "fliZ", "greA", "rho", "rpoA", "rpoD",
  
  # Translation-related genes
  "fusA", "infA", "rnpA", "rpmB", "rpmG", "rpmH", "rpsG", "rpsU", "trmD",
  
  # Hypothetical or unknown function genes
  "yabO", "yagP", "ychB", "ydiY", "yebE", "yebF", "yeeN", "yfgB", "yfhN",
  "yfhO", "yghB", "yhjG", "yi52–10", "yibB", "yjeS", "ylaC", "yleA"
)

# Create a data frame for norfloxacin expression values from Table 1
nor_df <- data.frame(
  Gene = c("polB", "recA", "recN", "sbmC", "ssb", "sulA", "uvrA", "uvrB", "dnaA", "nrdA", "nrdB",
           "fliA", "fliZ", "greA", "rho", "rpoA", "rpoD", "deoA", "deoB", "deoC", "dnaG", "gmk",
           "gyrA", "gyrB", "intZ", "mcrB", "oraA", "pyrG", "yabO", "yagP", "ychB", "ydiY", "yebE",
           "yfgB", "yfhN", "yfhO", "yghB", "yhjG", "yi52–10", "yibB", "yjeS", "ylaC", "yleA"),
  
  Nor_0.5_MIC = c(0.93, 3.79, 2.36, 1.14, 0.85, 1.36, 1.49, 1.25, 0.95, 1.48, 1.27, 1.18, 0.69, 
                  0.99, 1.04, 0.86, 0.99, 1.12, 1.21, 1.19, 0.98, 1.03, 0.97, 0.76, 0.84, 1.02, 
                  0.98, 1.04, 0.93, 0.97, 0.86, 0.86, 1.09, 0.97, 0.93, 0.83, 0.98, 0.87, 1.02, 
                  1.00, 0.96, 0.85, 0.94),
  
  Nor_1_MIC = c(1.22, 6.37, 3.65, 2.78, 1.06, 2.84, 2.12, 1.23, 1.25, 1.30, 1.08, 0.88, 0.71, 
                0.97, 1.02, 0.80, 2.05, 1.28, 1.29, 1.15, 1.11, 1.06, 0.88, 1.00, 0.85, 0.92, 
                0.92, 0.94, 0.93, 0.86, 0.97, 0.88, 0.97, 0.89, 0.89, 0.75, 0.91, 0.69, 0.86, 
                0.94, 0.81, 0.92, 0.81),
  
  Nor_2_MIC = c(1.31, 11.10, 4.82, 5.59, 1.00, 4.50, 1.97, 1.39, 1.16, 1.65, 1.48, 0.98, 0.39, 
                1.93, 0.67, 0.75, 4.64, 1.32, 3.25, 1.42, 1.69, 2.35, 0.84, 0.97, 0.81, 1.03, 
                1.21, 1.03, 1.07, 1.03, 1.62, 0.92, 1.01, 1.62, 1.27, 1.74, 1.08, 0.94, 1.03, 
                1.53, 1.21, 2.39, 1.43),
  
  Nor_33_MIC = c(4.84, 47.61, 16.14, 0.93, 2.94, 6.44, 21.63, 3.40, 3.65, 8.92, 3.96, 2.81, 
                 2.72, 4.35, 3.23, 0.35, 7.85, 2.25, 4.09, 5.24, 4.69, 2.69, 7.07, 5.09, 2.64, 
                 4.54, 5.11, 7.41, 3.71, 2.83, 5.21, 3.46, 1.52, 2.09, 3.18, 4.44, 4.08, 2.90, 
                 2.35, 3.18, 2.78, 3.18, 3.56),
  
  Nor_133_MIC = c(4.27, 47.55, 11.69, 0.83, 3.75, 4.98, 46.35, 4.71, 3.68, 5.17, 2.07, 4.44, 
                  5.25, 3.86, 4.09, 0.22, 9.45, 1.75, 6.07, 6.83, 5.73, 3.95, 8.85, 6.02, 3.64, 
                  5.05, 5.35, 9.76, 3.61, 3.56, 3.63, 2.44, 1.66, 3.01, 3.26, 5.28, 6.82, 4.93, 
                  3.43, 4.68, 3.98, 6.25, 6.25)
)

# View the data frame
rownames(nor_df)<-nor_df$Gene
nor_df <- log(nor_df[,-1], 2)
```

```{r}
#l2f_5_s4 <- na.omit(l2f_5_s4)
#l2f_5_s4$rownames <- rownames(l2f_5_s4)
#l2f_5_NC <- na.omit(l2f_5_NC)
#l2f_5_NC$rownames <- rownames(l2f_5_NC)
#l2f_18_s4 <- na.omit(l2f_18_s4)
#l2f_18_s4$rownames <- rownames(l2f_18_s4)
#l2f_18_NC <- na.omit(l2f_18_NC)
#l2f_18_NC$rownames <- rownames(l2f_18_NC)
#l <- list(l2f_5_NC, l2f_5_s4, l2f_18_NC, l2f_18_s4)
#l2f_df <- Reduce(function(x, y) merge(x, y, by="rownames", all=T), l)

#rownames(l2f_df) <- l2f_df$rownames
#l2f_df <- l2f_df[,-1]
#colnames(l2f_df) <- c("CasRx-gRNA-NT 5hr.", "CasRx-gRNA-s4 5hr.", "CasRx-gRNA-NT 18hr.", "CasRx-gRNA-s4 18hr.")

gene_overlap <- rownames(nor_df) %in% rownames(l2f_raw_df)
subset_l2f_df <- l2f_raw_df[rownames(l2f_raw_df) %in% rownames(nor_df), , drop=FALSE]
subset_nor_df <- nor_df[rownames(subset_l2f_df), , drop=FALSE]

subset_df <- Reduce(function(x,y) merge(x,y, by='row.names', all=T), list(subset_l2f_df, subset_nor_df))
rownames(subset_df)<-subset_df$Row.names
subset_df <- subset_df[, -1]
```

```{r}
var_nor <- apply(nor_df, MARGIN=1, FUN= var)
var_nor_df = data.frame(Var=var_nor)
rownames(var_nor_df) <- rownames(nor_df)

varNor_l2f_df <- nor_df[order(var_nor_df$Var, decreasing=FALSE), , drop=FALSE]
varNor_l2f_df

varNor_l2f_df <- varNor_l2f_df %>% rownames_to_column() %>% gather(colname, value, -rowname)

varNor_l2f_df <- varNor_l2f_df %>% mutate(timepoint = case_when(
  colname == "Nor_0.5_MIC" ~ "Norfloxacin 0.5MIC",
  colname == "Nor_1_MIC" ~ "Norfloxacin 1MIC",
  colname == "Nor_2_MIC" ~ "Norfloxacin 2MIC",
  colname == "Nor_33_MIC" ~ "Norfloxacin 33MIC",
  colname == "Nor_133_MIC" ~ "Norfloxacin 133MIC"
))

columns <- c("Norfloxacin\n0.5MIC", "Norfloxacin\n1MIC", "Norfloxacin\n2MIC", "Norfloxacin\n33MIC", "Norfloxacin\n133MIC")

varNor_l2f_df$colname  <- factor(varNor_l2f_df$colname, levels=c("Nor_0.5_MIC", "Nor_1_MIC", "Nor_2_MIC", "Nor_33_MIC", "Nor_133_MIC"))
varNor_l2f_df$timepoint <- factor(varNor_l2f_df$timepoint, levels=unique(varNor_l2f_df$timepoint))
varNor_l2f_df
varNor_l2f_df$rowname<-factor(varNor_l2f_df$rowname, levels=unique(varNor_l2f_df$rowname))

fsize = 7

nor_top_hits <- ggplot(varNor_l2f_df, aes(x=colname, y=rowname, fill=value)) + 
  geom_tile() +
  scale_fill_distiller(palette="RdGy") +
  theme(axis.text.x = element_text(family=font, size=fsize)) +
  theme(axis.text.y = element_text(family=font, size=fsize)) +
  coord_cartesian(clip = "off") +
  scale_x_discrete(labels = columns) +
  xlab("Treatment") +
  ylab("Gene")+
  labs(fill="Log2fold\nChange")
print(nor_top_hits)
ggsave("../Figures/NorTopHits.png", nor_top_hits, dpi=600)
```

```{r}
x_ann1 <- textGrob("Timepoint: 5hr.", gp=gpar(fontsize=10))
x_ann2 <- textGrob("Timepoint: 18hr.", gp=gpar(fontsize=10))

subset_sum_df<- data.frame(sort(rowSums(abs(subset_df)), decreasing=FALSE))
subset_df <- subset_df[rownames(subset_sum_df),]

subset_df2 <- subset_df %>% rownames_to_column() %>% gather(colname, value, -rowname)

subset_df2 <- subset_df2 %>% mutate(group = case_when(
  grepl("Targeting", colname)~"dCasRx",
  grepl("Nor", colname)~"Norfloxacin"
))
subset_df2 <- subset_df2 %>% mutate(label = case_when(
  colname == "Targeting5hr" ~ "Targeting\ngRNA 5hr",
  colname == "Targeting18hr" ~ "Targeting\ngRNA 18hr",
  colname == "Nor_0.5_MIC" ~ "Nofloxacin\n0.5MIC",
  colname == "Nor_1_MIC" ~ "Nofloxacin\n1MIC",
  colname == "Nor_2_MIC" ~ "Nofloxacin\n2MIC",
  colname == "Nor_33_MIC" ~ "Nofloxacin\n33MIC",
  colname == "Nor_133_MIC" ~ "Nofloxacin\n133MIC"
))

subset_df2$label <- factor(subset_df2$label, levels=c("Targeting\ngRNA 5hr", "Targeting\ngRNA 18hr", "Nofloxacin\n0.5MIC", "Nofloxacin\n1MIC", "Nofloxacin\n2MIC", "Nofloxacin\n33MIC", "Nofloxacin\n133MIC"))
subset_df2$colname  <- factor(subset_df2$colname, levels=c("Targeting5hr", "Targeting18hr", "Nor_0.5_MIC", "Nor_1_MIC", "Nor_2_MIC", "Nor_33_MIC", "Nor_133_MIC"))
subset_df2$rowname <- factor(subset_df2$rowname, levels=unique(subset_df2$rowname))

CasRx_df <- subset_df2 %>% filter(group=="CasRx")
Nor_df <- subset_df2 %>% filter(group=="Norfloxacin")

trt_comp <- ggplot(subset_df2, aes(x=label, y=rowname, fill=value)) + 
  geom_tile() +
  scale_fill_distiller(palette="RdGy", limits=c(-5,5)) +
  theme(axis.text.x = element_text(angle=45, hjust = 1, family=font)) +
  #theme( plot.margin=unit(c(2,2,2,2), "lines")) +
  #annotation_custom(x_ann1, xmin=1.5, xmax=1, ymin=6, ymax=6) +
  #annotation_custom(x_ann2, xmin= 3.5, xmax=3.5, ymin=6, ymax=6)+
  facet_wrap( ~group, scales="free_x" ) +
  #scale_x_discrete(labels = c("Non-Targeting gRNA", "Non-Targeting gRNA", "Targeing gRNA", "Targeting gRNA", "Norfloxacin 0.5MIC", "Norfloxacin 1MIC", "Norfloxacin 2MIC", "Norfloxacin 33MIC", "Norfloxacin 133MIC")) +
  coord_cartesian(clip = "off") +
  xlab("Treatment") +
  ylab("Gene")+
  labs(fill="Log2fold\nChange")

print(trt_comp)  
ggsave("../Figures/trt_compNC_vs_s4.png", trt_comp, dpi=600)
```

```{r}
n_topgenes <- 50
abs_sum_df <- data.frame(sort(rowSums(abs(l2f_df[1:n_topgenes, ])), decreasing=FALSE))
abs_sum_ind <- rownames(abs_sum_df)
for (i in 1:length(abs_sum_ind)){
  print(abs_sum_ind[length(abs_sum_ind)+1-i])  
}

```

```{r, fig.height=8, fig.width=6}
as_l2f_df <- l2f_df[rownames(abs_sum_df),]

as_l2f_df <- as_l2f_df %>% rownames_to_column() %>% gather(colname, value, -rowname)

as_l2f_df <- as_l2f_df %>% mutate(timepoint = case_when(
  colname == "Targeting5hr" ~ "Timepoint: 5hr",
  colname == "Targeting18hr" ~ "Timepoint: 18hr"
))

as_l2f_df$colname  <- factor(as_l2f_df$colname, levels=c("Targeting5hr", "Targeting18hr"))
as_l2f_df$timepoint <- factor(as_l2f_df$timepoint, levels=unique(as_l2f_df$timepoint))
as_l2f_df
as_l2f_df$rowname<-factor(as_l2f_df$rowname, levels=unique(as_l2f_df$rowname))

asTop_hits <- ggplot(as_l2f_df, aes(x=colname, y=rowname, fill=value)) + 
  geom_tile() +
  scale_fill_distiller(palette="RdGy") +
  theme(axis.text.x = element_text(family=font, size=fsize)) +
  theme(axis.text.y = element_text(family=font, size=fsize)) +
  coord_cartesian(clip = "off") +
  facet_wrap( ~timepoint, scales="free_x" ) +
  scale_x_discrete(labels = columns) +
  xlab("Treatment") +
  ylab("Gene")+
  labs(fill="Log2fold\nChange")

print(asTop_hits)
ggsave("../Figures/asTophitsNC_vs_s4.png", asTop_hits, dpi=600)
```

```{r, fig.height=12, fig.width=6}
scale = 0.7
var <- apply(l2f_df, MARGIN=1, FUN= var)
var_df = data.frame(Var=var)
rownames(var_df) <- rownames(l2f_df)

var_l2f_df <- l2f_df[order(var_df$Var, decreasing=FALSE), , drop=FALSE]
var_l2f_df <- var_l2f_df[var_df<scale*median(var_df$Var),]
var_l2f_df


var_l2f_df <- var_l2f_df %>% rownames_to_column() %>% gather(colname, value, -rowname)

var_l2f_df <- var_l2f_df %>% mutate(timepoint = case_when(
  colname == "Targeting5hr" ~ "Timepoint: 5hr",
  colname == "Targeting18hr" ~ "Timepoint: 18hr"
))


var_l2f_df$colname  <- factor(var_l2f_df$colname, levels=c("Targeting5hr", "Targeting18hr"))
var_l2f_df$timepoint <- factor(var_l2f_df$timepoint, levels=unique(var_l2f_df$timepoint))
var_l2f_df
var_l2f_df$rowname<-factor(var_l2f_df$rowname, levels=unique(var_l2f_df$rowname))

columns <- c("NT vs. T\n5hr.", "NT vs. T\n18hr")

fsize = 10

top_hits <- ggplot(var_l2f_df, aes(x=colname, y=rowname, fill=value)) + 
  geom_tile() +
  scale_fill_distiller(palette="RdGy") +
  theme(axis.text.x = element_text(family=font, size=fsize)) +
  theme(axis.text.y = element_text(family=font, size=fsize)) +
  coord_cartesian(clip = "off") +
  facet_wrap( ~timepoint, scales="free_x" ) +
  scale_x_discrete(labels = columns) +
  xlab("Treatment") +
  ylab("Gene")+
  labs(fill="Log2fold\nChange")
print(top_hits)
ggsave("../Figures/varTophitsNC_vs_s4.png", top_hits, dpi=600)
```

```

